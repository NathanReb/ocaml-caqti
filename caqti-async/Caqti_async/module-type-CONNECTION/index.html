<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>CONNECTION (caqti-async.Caqti_async.CONNECTION)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">caqti-async</a> &#x00BB; <a href="../index.html">Caqti_async</a> &#x00BB; CONNECTION</nav><h1>Module type <code>Caqti_async.CONNECTION</code></h1></header><div class="doc"><p>The connection API specialized for the current concurrency library.</p></div><div><div class="spec include"><div class="doc"><details open="open"><summary><span class="def"><code><span class="keyword">include </span><a href="../../../caqti/Caqti_connection_sig/index.html#module-type-Base">Caqti_connection_sig.Base</a></code></span></summary><dl><dt class="spec type" id="type-future"><a href="#type-future" class="anchor"></a><code><span class="keyword">type </span>+'a future</code></dt></dl><section><header><h2 id="query"><a href="#query" class="anchor"></a>Query</h2></header><div class="spec module" id="module-Response"><a href="#module-Response" class="anchor"></a><code><span class="keyword">module </span><a href="Response/index.html">Response</a> : <a href="../../../caqti/Caqti_response_sig/index.html#module-type-S">Caqti_response_sig.S</a><span class="keyword"> with </span><span class="keyword">type </span>'a <a href="../../../caqti/Caqti_response_sig/module-type-S/index.html#type-future">future</a> := <span class="type-var">'a</span> <a href="index.html#type-future">future</a></code></div><dl><dt class="spec value" id="val-call"><a href="#val-call" class="anchor"></a><code><span class="keyword">val </span>call : f:((<span class="type-var">'b</span>, <span class="type-var">'m</span>) <a href="Response/index.html#type-t">Response.t</a> <span>&#45;&gt;</span> (<span class="type-var">'c</span>, <span class="type-var">'e</span>) Stdlib.result <a href="index.html#type-future">future</a>) <span>&#45;&gt;</span> (<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'m</span>) <a href="../../../caqti/Caqti_request/index.html#type-t">Caqti_request.t</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> (<span class="type-var">'c</span>, [&gt; <a href="../../../caqti/Caqti_error/index.html#type-call">Caqti_error.call</a> ]<span class="keyword"> as </span>e) Stdlib.result <a href="index.html#type-future">future</a></code></dt><dd><p><code>call ~f request params</code> performs <code>request</code> with parameters <code>params</code> invoking <code>f</code> to process the result. The argument of <code>f</code> is only valid during the call to <code>f</code>, and must not be returned or operated on by other threads.</p></dd></dl></section><section><header><h2 id="transactions"><a href="#transactions" class="anchor"></a>Transactions</h2></header><dl><dt class="spec value" id="val-start"><a href="#val-start" class="anchor"></a><code><span class="keyword">val </span>start : unit <span>&#45;&gt;</span> (unit, [&gt; <a href="../../../caqti/Caqti_error/index.html#type-transact">Caqti_error.transact</a> ]) Stdlib.result <a href="index.html#type-future">future</a></code></dt><dd><p>Starts a transaction if supported by the underlying database, otherwise does nothing.</p></dd></dl><dl><dt class="spec value" id="val-commit"><a href="#val-commit" class="anchor"></a><code><span class="keyword">val </span>commit : unit <span>&#45;&gt;</span> (unit, [&gt; <a href="../../../caqti/Caqti_error/index.html#type-transact">Caqti_error.transact</a> ]) Stdlib.result <a href="index.html#type-future">future</a></code></dt><dd><p>Commits the current transaction if supported by the underlying database, otherwise does nothing.</p></dd></dl><dl><dt class="spec value" id="val-rollback"><a href="#val-rollback" class="anchor"></a><code><span class="keyword">val </span>rollback : unit <span>&#45;&gt;</span> (unit, [&gt; <a href="../../../caqti/Caqti_error/index.html#type-transact">Caqti_error.transact</a> ]) Stdlib.result <a href="index.html#type-future">future</a></code></dt><dd><p>Rolls back a transaction if supported by the underlying database, otherwise does nothing.</p></dd></dl></section><section><header><h2 id="disconnection-and-reuse"><a href="#disconnection-and-reuse" class="anchor"></a>Disconnection and Reuse</h2></header><dl><dt class="spec value" id="val-disconnect"><a href="#val-disconnect" class="anchor"></a><code><span class="keyword">val </span>disconnect : unit <span>&#45;&gt;</span> unit <a href="index.html#type-future">future</a></code></dt><dd><p>Calling <code>disconnect ()</code> closes the connection to the database and frees up related resources.</p></dd></dl><dl><dt class="spec value" id="val-validate"><a href="#val-validate" class="anchor"></a><code><span class="keyword">val </span>validate : unit <span>&#45;&gt;</span> bool <a href="index.html#type-future">future</a></code></dt><dd><p>For internal use by <a href="../../../caqti/Caqti_pool/index.html"><code>Caqti_pool</code></a>. Tries to ensure the validity of the connection and must return <code>false</code> if unsuccessful.</p></dd></dl><dl><dt class="spec value" id="val-check"><a href="#val-check" class="anchor"></a><code><span class="keyword">val </span>check : (bool <span>&#45;&gt;</span> unit) <span>&#45;&gt;</span> unit</code></dt><dd><p>For internal use by <a href="../../../caqti/Caqti_pool/index.html"><code>Caqti_pool</code></a>. Called after a connection has been used. <code>check f</code> must call <code>f ()</code> exactly once with an argument indicating whether to keep the connection in the pool or discard it.</p></dd></dl></section></details></div></div></div><dl><dt class="spec value" id="val-driver_info"><a href="#val-driver_info" class="anchor"></a><code><span class="keyword">val </span>driver_info : <a href="../../../caqti/Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a></code></dt><dd><p>Information about the driver providing this connection module.</p></dd></dl><section><header><h2 id="retrieval-convenience"><a href="#retrieval-convenience" class="anchor"></a>Retrieval Convenience</h2><p>These are shortcuts for <a href="index.html#val-call"><code>call</code></a> combined with retrieval functions from <a href="../../../caqti/Caqti_response_sig/module-type-S/index.html"><code>Caqti_response_sig.S</code></a> of the same name.</p></header><dl><dt class="spec value" id="val-exec"><a href="#val-exec" class="anchor"></a><code><span class="keyword">val </span>exec : (<span class="type-var">'a</span>, unit, [&lt; `Zero ]) <a href="../../../caqti/Caqti_request/index.html#type-t">Caqti_request.t</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> (unit, [&gt; <a href="../../../caqti/Caqti_error/index.html#type-call_or_retrieve">Caqti_error.call_or_retrieve</a> ]<span class="keyword"> as </span>e) Stdlib.result <a href="index.html#type-future">future</a></code></dt><dd><p>Combining <a href="index.html#val-call"><code>call</code></a> with <a href="Response/index.html#val-exec"><code>Response.exec</code></a>, this sends a request to the database and checks that no rows are returned.</p></dd></dl><dl><dt class="spec value" id="val-find"><a href="#val-find" class="anchor"></a><code><span class="keyword">val </span>find : (<span class="type-var">'a</span>, <span class="type-var">'b</span>, [&lt; `One ]) <a href="../../../caqti/Caqti_request/index.html#type-t">Caqti_request.t</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> (<span class="type-var">'b</span>, [&gt; <a href="../../../caqti/Caqti_error/index.html#type-call_or_retrieve">Caqti_error.call_or_retrieve</a> ]<span class="keyword"> as </span>e) Stdlib.result <a href="index.html#type-future">future</a></code></dt><dd><p>Combining <a href="index.html#val-call"><code>call</code></a> with <a href="Response/index.html#val-find"><code>Response.find</code></a>, this sends a request to the database, checks that a single row is returned, and extracts it.</p></dd></dl><dl><dt class="spec value" id="val-find_opt"><a href="#val-find_opt" class="anchor"></a><code><span class="keyword">val </span>find_opt : (<span class="type-var">'a</span>, <span class="type-var">'b</span>, [&lt; `Zero<span class="keyword"> | </span>`One ]) <a href="../../../caqti/Caqti_request/index.html#type-t">Caqti_request.t</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> (<span class="type-var">'b</span> option, [&gt; <a href="../../../caqti/Caqti_error/index.html#type-call_or_retrieve">Caqti_error.call_or_retrieve</a> ]<span class="keyword"> as </span>e) Stdlib.result <a href="index.html#type-future">future</a></code></dt><dd><p>Combining <a href="index.html#val-call"><code>call</code></a> with <a href="Response/index.html#val-find_opt"><code>Response.find_opt</code></a>, this sends a request to the database, checks that at most one row is returned, and extracts it if present.</p></dd></dl><dl><dt class="spec value" id="val-fold"><a href="#val-fold" class="anchor"></a><code><span class="keyword">val </span>fold : (<span class="type-var">'a</span>, <span class="type-var">'b</span>, [&lt; `Zero<span class="keyword"> | </span>`One<span class="keyword"> | </span>`Many ]) <a href="../../../caqti/Caqti_request/index.html#type-t">Caqti_request.t</a> <span>&#45;&gt;</span> (<span class="type-var">'b</span> <span>&#45;&gt;</span> <span class="type-var">'c</span> <span>&#45;&gt;</span> <span class="type-var">'c</span>) <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <span class="type-var">'c</span> <span>&#45;&gt;</span> (<span class="type-var">'c</span>, [&gt; <a href="../../../caqti/Caqti_error/index.html#type-call_or_retrieve">Caqti_error.call_or_retrieve</a> ]<span class="keyword"> as </span>e) Stdlib.result <a href="index.html#type-future">future</a></code></dt><dd><p>Combining <a href="index.html#val-call"><code>call</code></a> with <a href="Response/index.html#val-fold"><code>Response.fold</code></a>, this sends a request to the database and folds over the result rows.</p></dd></dl><dl><dt class="spec value" id="val-fold_s"><a href="#val-fold_s" class="anchor"></a><code><span class="keyword">val </span>fold_s : (<span class="type-var">'a</span>, <span class="type-var">'b</span>, [&lt; `Zero<span class="keyword"> | </span>`One<span class="keyword"> | </span>`Many ]) <a href="../../../caqti/Caqti_request/index.html#type-t">Caqti_request.t</a> <span>&#45;&gt;</span> (<span class="type-var">'b</span> <span>&#45;&gt;</span> <span class="type-var">'c</span> <span>&#45;&gt;</span> (<span class="type-var">'c</span>, <span class="type-var">'e</span>) Stdlib.result <a href="index.html#type-future">future</a>) <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <span class="type-var">'c</span> <span>&#45;&gt;</span> (<span class="type-var">'c</span>, [&gt; <a href="../../../caqti/Caqti_error/index.html#type-call_or_retrieve">Caqti_error.call_or_retrieve</a> ]<span class="keyword"> as </span>e) Stdlib.result <a href="index.html#type-future">future</a></code></dt><dd><p>Combining <a href="index.html#val-call"><code>call</code></a> with <a href="Response/index.html#val-fold_s"><code>Response.fold_s</code></a>, this sends a request to the database and folds concurrently over the result rows.</p><p>Please be aware of possible deadlocks when using resources from the callback. In particular, if the same connection pool is invoked as the one used to obtain the current connection, it will deadlock if the pool has just run out of connections. An alternative is to collect the rows first e.g. with <a href="index.html#val-fold"><code>fold</code></a> and do the nested queries after exiting.</p></dd></dl><dl><dt class="spec value" id="val-iter_s"><a href="#val-iter_s" class="anchor"></a><code><span class="keyword">val </span>iter_s : (<span class="type-var">'a</span>, <span class="type-var">'b</span>, [&lt; `Zero<span class="keyword"> | </span>`One<span class="keyword"> | </span>`Many ]) <a href="../../../caqti/Caqti_request/index.html#type-t">Caqti_request.t</a> <span>&#45;&gt;</span> (<span class="type-var">'b</span> <span>&#45;&gt;</span> (unit, <span class="type-var">'e</span>) Stdlib.result <a href="index.html#type-future">future</a>) <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> (unit, [&gt; <a href="../../../caqti/Caqti_error/index.html#type-call_or_retrieve">Caqti_error.call_or_retrieve</a> ]<span class="keyword"> as </span>e) Stdlib.result <a href="index.html#type-future">future</a></code></dt><dd><p>Combining <a href="index.html#val-call"><code>call</code></a> with <a href="Response/index.html#val-iter_s"><code>Response.iter_s</code></a>, this sends a request to the database and iterates concurrently over the result rows. Please see the warning in <a href="index.html#val-fold_s"><code>fold_s</code></a> about resource usage in the callback.</p></dd></dl><dl><dt class="spec value" id="val-collect_list"><a href="#val-collect_list" class="anchor"></a><code><span class="keyword">val </span>collect_list : (<span class="type-var">'a</span>, <span class="type-var">'b</span>, [&lt; `Zero<span class="keyword"> | </span>`One<span class="keyword"> | </span>`Many ]) <a href="../../../caqti/Caqti_request/index.html#type-t">Caqti_request.t</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> (<span class="type-var">'b</span> list, [&gt; <a href="../../../caqti/Caqti_error/index.html#type-call_or_retrieve">Caqti_error.call_or_retrieve</a> ]<span class="keyword"> as </span>e) Stdlib.result <a href="index.html#type-future">future</a></code></dt><dd><p><code>collect_list request param</code> performs a <a href="index.html#val-call"><code>call</code></a> on <code>request</code>, extracting the result as a list.</p></dd></dl><dl><dt class="spec value" id="val-rev_collect_list"><a href="#val-rev_collect_list" class="anchor"></a><code><span class="keyword">val </span>rev_collect_list : (<span class="type-var">'a</span>, <span class="type-var">'b</span>, [&lt; `Zero<span class="keyword"> | </span>`One<span class="keyword"> | </span>`Many ]) <a href="../../../caqti/Caqti_request/index.html#type-t">Caqti_request.t</a> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> (<span class="type-var">'b</span> list, [&gt; <a href="../../../caqti/Caqti_error/index.html#type-call_or_retrieve">Caqti_error.call_or_retrieve</a> ]<span class="keyword"> as </span>e) Stdlib.result <a href="index.html#type-future">future</a></code></dt><dd><p><code>rev_collect_list request param</code> performs a <a href="index.html#val-call"><code>call</code></a> on <code>request</code>, extracting the result as a reversed list. This is more efficient than <code>find_list</code> and fits well with a subsequent <span class="xref-unresolved" title="unresolved reference to &quot;List.rev_map&quot;"><code>List</code>.rev_map</span>, though it may not matter much in practise.</p></dd></dl></section></div></body></html>